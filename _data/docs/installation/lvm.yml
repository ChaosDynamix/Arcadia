name: lvm
package: lvm2

scenario:

  lvm-luks:
    has-encrypted-volumes: false
    vg: grp
    lvs:
      - name: root
        mkdir: false
        node: /dev/grp/root
        size: "15-20 GiB"
      - name: swap
        mkdir: false
        node: /dev/grp/swap
        size: "> 512M"
      - name: var
        mkdir: true
        node: /dev/grp/var
        size: "8-12 GiB"
      - name: home
        mkdir: true
        node: /dev/grp/home
        size: "100%FREE - 5G"

  luks-lvm:
    has-encrypted-volumes: true
    vg: grp
    lvs:
      - name: cryptroot
        mkdir: false
        has-fixed-size: true
        node: /dev/grp/cryptroot
        size: "23-32 GiB"
      - name: cryptswap
        mkdir: false
        has-fixed-size: true
        node: /dev/grp/cryptswap
        size: "> 512M"
      - name: crypthome
        mkdir: true
        has-fixed-size: false
        node: /dev/grp/crypthome
        size: 100%FREE

template:

  luks-single-partition:
    has-raid: false
    has-swapfile: false
    devices:
      - id: 1
        node: /dev/sda
    firmware-partitions:
      - id: 1
        node: /dev/sda1
        type: firmware_partition_type
        size: firmware_partition_size
        efi-label: EFI
    system-partitions:
      - id: 2
        node: /dev/sda2
        type: Linux LUKS partition
        size: 100%FREE
    containers:
      - id: 1
        name: cryptlvm
        headerless: false
        node: /dev/sda2
        mapper: /dev/mapper/cryptlvm
        keyfile: cryptlvm.keyfile
    script:
      sgdisk: |
        $ sgdisk -o firmware_script_sgdisk -n=2:0:0 -t=2:8309 /dev/sda
    configuration:
      mkinitcpio: |
        FILES=(/etc/luks-key/cryptlvm.keyfile)
        HOOKS=(base udev autodetect modconf block encrypt lvm2 filesystems keyboard keymap fsck)
      grub: |
        GRUB_CMDLINE_LINUX_DEFAULT="cryptdevice=/dev/sda2:cryptlvm cryptkey=rootfs:/etc/luks-keys/cryptlvm.keyfile root=/dev/grp/root loglevel=3 quiet"
        GRUB_ENABLE_CRYPTODISK=y

  luks-multiple-partitions:
    has-raid: false
    has-swapfile: false
    devices:
      - id: 1
        node: /dev/sda
      - id: 2
        node: /dev/sdb
    firmware-partitions:
      - id: 1
        node: /dev/sda1
        type: firmware_partition_type
        size: firmware_partition_size
        efi-label: EFI
    system-partitions:
      - id: 2
        node: /dev/sda2
        type: Linux LUKS partition
        size: 100%FREE
      - id: 3
        node: /dev/sdb1
        type: Linux LUKS partition
        size: 100%FREE
    containers:
      - id: 1
        name: cryptlvm1
        headerless: false
        node: /dev/sda2
        mapper: /dev/mapper/cryptlvm1
        keyfile: cryptlvm1.keyfile
      - id: 2
        name: cryptlvm2
        headerless: false
        node: /dev/sdb1
        mapper: /dev/mapper/cryptlvm2
        keyfile: cryptlvm2.keyfile
    script:
      sgdisk: |
        $ sgdisk -o firmware_script_sgdisk -n=2:0:0 -t=2:8309 /dev/sda
        $ sgdisk -o -n=1:0:0 -t=1:8309 /dev/sdb
    configuration:
      mkinitcpio: |
        FILES=(/etc/luks-keys/cryptlvm1.keyfile /etc/luks-keys/cryptlvm2.keyfile)
        HOOKS=(base systemd autodetect modconf block sd-encrypt sd-lvm2 filesystems keyboard sd-vconsole fsck)
      grub: |
        GRUB_CMDLINE_LINUX_DEFAULT="root=/dev/grp/root loglevel=3 quiet"
        GRUB_ENABLE_CRYPTODISK=y

  luks-raid:
    has-raid: true
    has-swapfile: false
    devices:
      - id: 1
        node: /dev/sda
      - id: 2
        node: /dev/sdb
    firmware-partitions:
      - id: 1
        node: /dev/sda1
        type: firmware_partition_type
        size: firmware_partition_size
        efi-label: EFI1
      - id: 3
        node: /dev/sdb1
        type: firmware_partition_type
        size: firmware_partition_size
        efi-label: EFI2
    system-partitions:
      - id: 2
        node: /dev/sda2
        type: Linux RAID partition
        size: 100%FREE - 100M
      - id: 4
        node: /dev/sdb2
        type: Linux RAID partition
        size: 100%FREE - 100M
    containers:
      - id: 1
        name: cryptlvm
        headerless: false
        node: /dev/md/array
        mapper: /dev/mapper/cryptlvm
        keyfile: cryptlvm.keyfile
    script:
      sgdisk: |
        $ sgdisk -o firmware_script_sgdisk -n=2:0:-100M -t=2:fd00 -R=/dev/sdb /dev/sda
        $ sgdisk -G /dev/sdb
    configuration:
      mkinitcpio: |
        FILES=(/etc/luks-key/cryptlvm.keyfile)
        HOOKS=(base udev autodetect modconf block mdadm_udev encrypt lvm2 filesystems keyboard keymap fsck)
      grub: |
        GRUB_CMDLINE_LINUX_DEFAULT="cryptdevice=/dev/md/array:cryptlvm cryptkey=rootfs:/etc/luks-keys/cryptlvm.keyfile root=/dev/grp/root loglevel=3 quiet"
        GRUB_ENABLE_CRYPTODISK=y

  luks-logical-volumes:
    has-raid: false
    has-swapfile: false
    devices:
      - id: 1
        node: /dev/sda
      - id: 2
        node: /dev/sdb
    firmware-partitions:
      - id: 1
        node: /dev/sda1
        type: firmware_partition_type
        size: firmware_partition_size
        efi-label: EFI
    system-partitions:
      - id: 2
        node: /dev/sda2
        type: Linux LVM
        size: 100%FREE
      - id: 3
        node: /dev/sdb1
        type: Linux LVM
        size: 100%FREE
    containers:
      - id: 1
        name: root
        headerless: false
        node: /dev/grp/cryptroot
        mapper: /dev/mapper/root
        keyfile: cryptroot.keyfile
      - id: 2
        name: home
        headerless: false
        node: /dev/grp/crypthome
        mapper: /dev/mapper/home
        keyfile: crypthome.keyfile
    script:
      sgdisk: |
        $ sgdisk -o firmware_script_sgdisk -n=2:0:0 -t=2:8e00 /dev/sda
        $ sgdisk -o -n=1:0:0 -t=1:8e00 /dev/sdb
    configuration:
      mkinitcpio: |
        FILES=(/etc/luks-key/cryptroot.keyfile)
        HOOKS=(base udev autodetect modconf block encrypt lvm2 filesystems keyboard keymap fsck)
      grub: |
        GRUB_CMDLINE_LINUX_DEFAULT="cryptdevice=/dev/grp/cryptroot:root cryptkey=rootfs:/etc/luks-keys/cryptroot.keyfile root=/dev/mapper/root loglevel=3 quiet"
        GRUB_ENABLE_CRYPTODISK=y
